<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Formularios Ayudas T√©cnicas PRO</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f0f2f5; }
        
        /* Panel Izquierdo */
        #sidebar { width: 340px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; gap: 15px; z-index: 10; }
        h2 { margin: 10px 0 0 0; font-size: 1.1rem; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .form-group { display: flex; flex-direction: column; gap: 3px; margin-bottom: 5px; }
        .form-group label { font-size: 0.8rem; font-weight: bold; color: #555; }
        .form-group input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        
        /* Herramientas */
        .toolbar { display: flex; flex-wrap: wrap; gap: 5px; background: #e8f4f8; padding: 10px; border-radius: 6px; border: 1px solid #bde0ec; margin-top: 10px;}
        .tool-btn { flex: 1; padding: 8px 5px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .tool-btn.active { background: #3498db; color: white; border-color: #2980b9; }
        .tool-btn:hover:not(.active) { background: #f0f0f0; }

        /* Botones Principales */
        .btn-main { background: #2ecc71; color: white; border: none; padding: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background 0.3s; margin-top: 15px;}
        .btn-main:hover { background: #27ae60; }
        .btn-print { background: #e67e22; }
        .btn-print:hover { background: #d35400; }

        /* Footer */
        .app-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; text-align: center; font-size: 0.75rem; color: #7f8c8d; line-height: 1.4; }

        /* Panel Derecho (Scroll de p√°ginas) */
        #main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #top-bar { padding: 10px 20px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #coordDisplay { font-family: monospace; font-size: 1.1rem; color: #c0392b; font-weight: bold; }
        
        #paginas-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 30px; background-color: #636e72; }
        .pagina-wrapper { position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); background: white; }
        .pagina-titulo { position: absolute; top: -25px; left: 0; color: white; font-weight: bold; background: #2d3436; padding: 2px 10px; border-radius: 4px 4px 0 0; font-size: 0.8rem; }
        canvas { display: block; max-width: 900px; height: auto; }

        /* --- ESTILOS DE IMPRESI√ìN --- */
        @media print {
            /* Ocultar barra lateral, barra superior y los t√≠tulos negros */
            #sidebar, #top-bar, .pagina-titulo { display: none !important; }
            
            /* Resetear m√°rgenes y fondos para la hoja blanca */
            body, #main, #paginas-container { 
                background: white !important; margin: 0 !important; padding: 0 !important; 
                height: auto !important; overflow: visible !important; display: block !important;
            }

            /* Forzar salto de p√°gina despu√©s de cada documento */
            .pagina-wrapper { 
                box-shadow: none !important; margin: 0 !important; padding: 0 !important;
                page-break-after: always;
            }

            /* Evitar una hoja en blanco extra al final */
            .pagina-wrapper:last-child { page-break-after: auto; }

            /* Ajustar el tama√±o del formulario a la hoja */
            canvas { 
                width: 100% !important; max-width: 21.5cm !important; height: auto !important; 
                margin: 0 auto !important; display: block !important;
            }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Datos del Paciente</h2>
        <div class="form-group"><label>Nombres</label><input type="text" id="in_nombres" oninput="renderAll()"></div>
        <div class="form-group"><label>Apellidos</label><input type="text" id="in_apellidos" oninput="renderAll()"></div>
        <div class="form-group"><label>RUT</label><input type="text" id="in_rut" oninput="renderAll()"></div>
        <div class="form-group"><label>Edad</label><input type="text" id="in_edad" oninput="renderAll()"></div>
        <div class="form-group"><label>Fecha Nacimiento (Ej: 15/05/1980)</label><input type="text" id="in_fechanac" oninput="renderAll()"></div>
        <div class="form-group"><label>Direcci√≥n</label><input type="text" id="in_direccion" oninput="renderAll()"></div>
        <div class="form-group"><label>Comuna</label><input type="text" id="in_comuna" oninput="renderAll()"></div>
        <div class="form-group"><label>Regi√≥n</label><input type="text" id="in_region" oninput="renderAll()"></div>
        <div class="form-group"><label>Tel√©fono</label><input type="text" id="in_telefono" oninput="renderAll()"></div>

        <h2>Datos del Profesional</h2>
        <div class="form-group"><label>Nombres Dr(a).</label><input type="text" id="in_doc_nombres" oninput="renderAll()"></div>
        <div class="form-group"><label>Apellidos Dr(a).</label><input type="text" id="in_doc_apellidos" oninput="renderAll()"></div>
        <div class="form-group"><label>RUT Dr(a).</label><input type="text" id="in_doc_rut" oninput="renderAll()"></div>
        
        <h2>Configuraci√≥n</h2>
        <div class="form-group">
            <label>N¬∫ de Ayudas T√©cnicas a solicitar:</label>
            <input type="number" id="in_cantidad" value="1" min="1" max="10" onchange="generarEstructura()">
        </div>

        <h2>Herramientas Manuales</h2>
        <div class="toolbar">
            <button class="tool-btn active" id="btn_debug" onclick="setTool('debug')">üìç Coordenadas</button>
            <button class="tool-btn" id="btn_x" onclick="setTool('x')">‚ùå Poner 'X'</button>
            <button class="tool-btn" id="btn_texto" onclick="setTool('texto')">üìù Texto Libre</button>
            <button class="tool-btn" id="btn_goma" onclick="setTool('goma')">üßπ Borrar</button>
        </div>

        <button class="btn-main btn-print" onclick="imprimirDocumentos()">üñ®Ô∏è Imprimir Todo</button>

        <div class="app-footer">
            hecho con <span style="color: #e74c3c; font-size: 0.9rem;">‚ù§Ô∏è</span> por pedro errazuriz<br>
            @mediayuda_ / version 2.0 / febrero 2025
        </div>
    </div>

    <div id="main">
        <div id="top-bar">
            <span style="font-weight: bold; color: #2c3e50;">Vista Previa de Documentos</span>
            <span>Coordenadas del mouse: <span id="coordDisplay">X: --, Y: --</span></span>
        </div>
        <div id="paginas-container">
            </div>
    </div>

    <script>
        // --- ESTADO DE LA APLICACI√ìN ---
        let toolActiva = 'debug'; 
        let elementosPersonalizados = {}; 
        
        const imagenes = { ges: new Image(), ipd: new Image(), orden: new Image() };
        let imagenesCargadas = 0;

        imagenes.ges.src = 'ges.jpg';
        imagenes.ipd.src = 'ipd.jpg';
        imagenes.orden.src = 'orden.jpg';

        // --- CONSTANTES FIJAS ---
        const constantes = {
            hospital: "Hospital Claudio Vicu√±a",
            region_hosp: "V",
            direccion_hosp: "Carmen Guerrero 945, San Antonio",
	    ciudad_hosp: "San Antonio"
        };

        // --- DICCIONARIO DE COORDENADAS ---
        const coordBase = {
            ges: { 
                nombres: [235, 450], apellidos: [740, 450], rut: [150, 560],
                direccion: [200, 610], comuna: [890, 610], region: [170, 660], telefono: [485, 665],
                hospital: [533, 200], direccion_hosp: [195, 250], ciudad_hosp: [890,250], 
                fecha_completa: [375, 1160], doc_rut: [150, 360],  doc_nombres: [380, 300], doc_apellidos: [740, 300]
            },
            ipd: { 
                nombres: [630, 290], apellidos: [120, 290], rut: [135, 338],
                edad: [748, 375], fechanac: [355, 375],
                doc_nombres: [685, 1166], doc_apellidos: [150, 1166], doc_rut: [128, 1224],
                hospital: [0, 0], region_hosp: [0, 0],
                fecha_dia: [460, 138], fecha_mes: [528, 138], fecha_anio: [596, 138] 
            },
            orden: { 
                nombres: [700, 290], apellidos: [146, 290], rut: [125, 340],
                edad: [750, 405], fechanac: [415, 430], direccion: [326, 491], comuna: [111, 526], telefono: [420, 520],
                doc_nombres: [690, 1116], doc_apellidos: [160, 1116], doc_rut: [120, 1174],
                hospital: [0, 0],
                fecha_dia: [398, 173], fecha_mes: [455, 173], fecha_anio: [511, 173]
            }
        };

        function checkLoad() {
            imagenesCargadas++;
            if(imagenesCargadas === 3) generarEstructura();
        }
        imagenes.ges.onload = checkLoad; imagenes.ipd.onload = checkLoad; imagenes.orden.onload = checkLoad;

        function setTool(tool) {
            toolActiva = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn_' + tool).classList.add('active');
            
            const cursores = { 'debug': 'crosshair', 'x': 'cell', 'texto': 'text', 'goma': 'not-allowed' };
            document.querySelectorAll('canvas').forEach(c => c.style.cursor = cursores[tool]);
        }

        function generarEstructura() {
            const container = document.getElementById('paginas-container');
            container.innerHTML = ''; 
            const cantidad = parseInt(document.getElementById('in_cantidad').value) || 1;

            crearCanvasEnDOM(container, 'ges', 'ges_0', 'Formulario GES (√önico)');
            for(let i = 0; i < cantidad; i++) {
                crearCanvasEnDOM(container, 'ipd', `ipd_${i}`, `IPD - Ayuda T√©cnica #${i+1}`);
                crearCanvasEnDOM(container, 'orden', `orden_${i}`, `Orden de Atenci√≥n - Ayuda T√©cnica #${i+1}`);
            }
            setTool(toolActiva);
            renderAll();
        }

        function crearCanvasEnDOM(container, tipoDoc, idCanvas, titulo) {
            const wrapper = document.createElement('div');
            wrapper.className = 'pagina-wrapper';
            
            const label = document.createElement('div');
            label.className = 'pagina-titulo';
            label.innerText = titulo;

            const canvas = document.createElement('canvas');
            canvas.id = idCanvas;
            canvas.dataset.tipo = tipoDoc; 
            canvas.width = imagenes[tipoDoc].width;
            canvas.height = imagenes[tipoDoc].height;

            canvas.addEventListener('mousemove', manejarMouseMove);
            canvas.addEventListener('mousedown', manejarClick);

            wrapper.appendChild(label);
            wrapper.appendChild(canvas);
            container.appendChild(wrapper);

            if(!elementosPersonalizados[idCanvas]) elementosPersonalizados[idCanvas] = [];
        }

        // --- MOTOR DE DIBUJO ---
        function renderAll() {
            const canvases = document.querySelectorAll('canvas');
            
            const hoy = new Date();
            const dia = String(hoy.getDate()).padStart(2, '0');
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const anio = String(hoy.getFullYear());
            const anioCorto = anio.slice(-2); 

            const datosADibujar = {
                nombres: document.getElementById('in_nombres').value,
                apellidos: document.getElementById('in_apellidos').value,
                rut: document.getElementById('in_rut').value,
                edad: document.getElementById('in_edad').value,
                fechanac: document.getElementById('in_fechanac').value,
                direccion: document.getElementById('in_direccion').value,
                comuna: document.getElementById('in_comuna').value,
                region: document.getElementById('in_region').value,
                telefono: document.getElementById('in_telefono').value,
                
                doc_nombres: document.getElementById('in_doc_nombres').value,
                doc_apellidos: document.getElementById('in_doc_apellidos').value,
                doc_rut: document.getElementById('in_doc_rut').value,
                
                hospital: constantes.hospital,
                region_hosp: constantes.region_hosp,
                direccion_hosp: constantes.direccion_hosp,
                ciudad_hosp: constantes.ciudad_hosp,
                
                fecha_dia: dia,
                fecha_mes: mes,
                fecha_anio: anio,
                fecha_anio_corto: anioCorto,
                fecha_completa: `${dia}/${mes}/${anio}`
            };

            canvases.forEach(canvas => {
                const ctx = canvas.getContext('2d');
                const tipo = canvas.dataset.tipo;
                const id = canvas.id;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(imagenes[tipo], 0, 0);

                ctx.fillStyle = "blue";
                ctx.font = "bold 24px Arial";

                const cb = coordBase[tipo];
                
                for (const [clave, valor] of Object.entries(datosADibujar)) {
                    if (valor && cb[clave]) {
                        if(cb[clave][0] !== 0 || cb[clave][1] !== 0) {
                            ctx.fillText(valor, cb[clave][0], cb[clave][1]);
                        }
                    }
                }

                const elems = elementosPersonalizados[id] || [];
                elems.forEach(el => {
                    if(el.tipo === 'x') {
                        ctx.font = "bold 35px Arial";
                        ctx.fillText("X", el.x - 10, el.y + 10); 
                    } else if (el.tipo === 'texto') {
                        ctx.font = "bold 24px Arial";
                        ctx.fillText(el.text, el.x, el.y);
                    }
                });
            });
        }

        // --- EVENTOS MOUSE ---
        function obtenerCoordsEscaladas(canvas, e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: Math.round((e.clientX - rect.left) * scaleX),
                y: Math.round((e.clientY - rect.top) * scaleY)
            };
        }

        function manejarMouseMove(e) {
            const coords = obtenerCoordsEscaladas(e.target, e);
            document.getElementById('coordDisplay').innerText = `X: ${coords.x}, Y: ${coords.y}`;
        }

        function manejarClick(e) {
            const canvas = e.target;
            const id = canvas.id;
            const coords = obtenerCoordsEscaladas(canvas, e);

            if (toolActiva === 'debug') {
                console.log(`[${canvas.dataset.tipo}] X: ${coords.x}, Y: ${coords.y}`);
            } 
            else if (toolActiva === 'x') {
                elementosPersonalizados[id].push({ tipo: 'x', x: coords.x, y: coords.y });
                renderAll();
            } 
            else if (toolActiva === 'texto') {
                const texto = prompt("Ingresa el texto a a√±adir en esta posici√≥n:");
                if (texto) {
                    elementosPersonalizados[id].push({ tipo: 'texto', text: texto, x: coords.x, y: coords.y });
                    renderAll();
                }
            } 
            else if (toolActiva === 'goma') {
                const elems = elementosPersonalizados[id];
                let indexABorrar = -1;
                let minDist = 40; 

                for(let i = elems.length - 1; i >= 0; i--) { 
                    const el = elems[i];
                    const dist = Math.sqrt(Math.pow(el.x - coords.x, 2) + Math.pow(el.y - coords.y, 2));
                    if(dist < minDist) {
                        minDist = dist;
                        indexABorrar = i;
                    }
                }

                if(indexABorrar !== -1) {
                    elementosPersonalizados[id].splice(indexABorrar, 1);
                    renderAll();
                }
            }
        }

        // --- IMPRESI√ìN CORREGIDA ---
        function imprimirDocumentos() {
            window.print();
        }

    </script>
</body>
</html>